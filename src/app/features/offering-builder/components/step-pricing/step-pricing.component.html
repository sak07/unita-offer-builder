<div class="step-container">

  <!-- Heading Section: title + Preview Card button (next to step name) -->
  <div class="heading-section">
    <div class="heading-text">
      <h1>Tier & Pricing Breakdown</h1>
      <p>Configure your offering price and (optional) tiers</p>
    </div>
    <button type="button" class="preview-card-btn" (click)="openPreview.emit()" aria-label="Preview card">
      <!-- <span class="material-icons" style="font-size: 20px;">visibility</span> -->
      <img src="assets/preview.png" alt="Preview" class="preview-icon" />
      Preview Card*
    </button>
  </div>

  <!-- Hint Bar -->
  <div class="hint-bar">
    <div class="hint-label">
      <span class="material-icons" style="font-size: 18px;">lightbulb</span>
      Hint!
    </div>
    <div class="hint-text">
      If your offering has tiers or variations, they will be added on the next step. These are details shared by all tiers.
    </div>
  </div>

  <!-- Mode Selector: Recommendations vs Editor -->
  <ng-container *ngIf="isShowRecommendations(); else editorView">
    <!-- Tiers Header -->
    <div class="tiers-header">
      <h2 class="tiers-title">Tiers</h2>
      <div class="offering-type-badge">
        Selected offering type:
        <span class="type-value">
          <span class="material-icons" style="font-size: 16px;">category</span>
          {{ getOfferingTypeLabel() }} <span class="dropdown-arrow">&#9662;</span>
        </span>
      </div>
    </div>

    <div class="recommendation-grid">
      <!-- AI Recommendation Card -->
      <div class="recommendation-card">
        <div class="ai-badge">
          <span class="material-icons" style="font-size: 14px;">auto_awesome</span>
          Unita AI
        </div>
        <div class="recommendation-content">
          <h3>Recommended tier structure for <strong>{{ getOfferingTypeLabel() }}s</strong>:</h3>
          <div class="structure-preview">
            <div class="structure-item">Starter</div>
            <div class="structure-item active">
              Professional
              <span class="material-icons" style="font-size: 14px; color: #fbbf24;">verified</span>
            </div>
            <div class="structure-item">Enterprise</div>
          </div>
          <p class="recommendation-desc">Service packages based on scope, deliverables, and support level.</p>
          <button (click)="useAiStructure()" class="use-structure-btn">Use This Structure</button>
        </div>
      </div>

      <!-- Manual Card -->
      <div class="manual-card">
        <h3>Build your own:</h3>
        <button (click)="manualCreation()" class="add-tier-btn">Add your own Tier</button>
      </div>
    </div>
  </ng-container>

  <ng-template #editorView>
    <!-- Tiers Header -->
    <div class="tiers-header">
      <h2 class="tiers-title">Tiers</h2>
      <div class="offering-type-badge">
        Selected offering type:
        <span class="type-value">
          <span class="material-icons" style="font-size: 16px;">category</span>
          {{ getOfferingTypeLabel() }} <span class="dropdown-arrow">&#9662;</span>
        </span>
      </div>
    </div>

    <div class="editor-card">
      <!-- Tier Tabs -->
      <div class="editor-header">
        <div class="tier-tabs">
          <div 
            *ngFor="let tier of state.offering().tiers; let i = index" 
            (click)="setActiveTier(i)"
            class="tier-tab" 
            [class.active]="activeTierIndex() === i"
          >
            <span class="material-icons drag-icon" style="font-size: 12px;">drag_indicator</span>
            {{ tier.name || 'Untitled Tier' }}
            <span *ngIf="tier.isPopular" class="material-icons" style="font-size: 14px; color: #fbbf24;">verified</span>
          </div>
        </div>
      </div>

      <div class="editor-body">
        <!-- Left Section: Tier Details -->
        <div class="editor-left">
          <div class="field-section">
            <h4 class="section-title">Tier Details</h4>
            
            <div class="input-block">
              <label>Tier Name</label>
              <div class="input-wrapper">
                <input 
                  [(ngModel)]="activeTier.name"
                  (ngModelChange)="state.updateTier(activeTier.id, { name: $event })"
                  placeholder="Professional"
                />
                <span class="char-count">{{ activeTier.name?.length || 0 }}/50</span>
              </div>
            </div>

            <div class="input-block">
              <div class="label-with-toggle">
                <label>Offering Display Name Overwrite</label>
                <label class="toggle-switch">
                  <input 
                    type="checkbox" 
                    [checked]="!!activeTier.displayNameOverwrite"
                    (change)="state.updateTier(activeTier.id, { displayNameOverwrite: activeTier.displayNameOverwrite ? undefined : '' })"
                  >
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div *ngIf="activeTier.displayNameOverwrite !== undefined" class="input-wrapper">
                <input 
                  [(ngModel)]="activeTier.displayNameOverwrite"
                  (ngModelChange)="state.updateTier(activeTier.id, { displayNameOverwrite: $event })"
                  placeholder="[Name of offering added on step 2]"
                  class="disabled-style"
                />
                <span class="char-count">{{ activeTier.displayNameOverwrite?.length || 0 }}/85</span>
              </div>
            </div>

            <div class="input-block">
              <label>Supersede Cheaper Tier</label>
              <div class="select-wrapper">
                <select 
                  [(ngModel)]="activeTier.supersedesTierId"
                  (ngModelChange)="state.updateTier(activeTier.id, { supersedesTierId: $event })"
                >
                  <option value="">None</option>
                  <option 
                    *ngFor="let t of state.offering().tiers" 
                    [hidden]="t.id === activeTier.id"
                    [value]="t.id"
                  >{{ t.name }}</option>
                </select>
                <span class="material-icons select-arrow" style="font-size: 16px;">arrow_drop_down</span>
              </div>
            </div>
          </div>

          <!-- Tier Features -->
          <div class="field-section">
            <h4 class="section-title">Tier Details</h4>
            <div *ngFor="let feat of activeTier.features; let fIdx = index" class="input-block">
              <div class="input-wrapper">
                <input 
                  [ngModel]="feat"
                  (ngModelChange)="state.updateTierFeature(activeTier.id, fIdx, $event)"
                  placeholder="Feature description..."
                />
                <span class="char-count">{{ feat?.length || 0 }}/50</span>
              </div>
            </div>
            <button (click)="state.addTierFeature(activeTier.id)" class="add-bullet-btn">Add Bullet Point</button>
          </div>
        </div>

        <!-- Right Section: Tier Pricing -->
        <div class="editor-right">
          <div class="field-section">
            <h4 class="section-title">Tier Pricing</h4>
            
            <div class="pricing-info-row">
              <div class="info-badge">
                <span class="material-icons" style="font-size: 14px;">info</span>
                Pricing type influenced by offering choice
              </div>
              <button class="adjust-type-link">
                <span class="material-icons" style="font-size: 14px;">settings</span>
                Adjust Offering Type
              </button>
            </div>

            <!-- Billing Type Toggle (Only for Service) -->
            <div *ngIf="state.offering().type === 'Service'" class="input-block">
              <label>Main Billing Type</label>
              <div class="billing-toggle">
                <button 
                  (click)="state.updateTier(activeTier.id, { billingType: 'Per Project' })"
                  class="billing-opt" 
                  [class.active]="activeTier.billingType === 'Per Project'"
                >Per Project</button>
                <button 
                  (click)="state.updateTier(activeTier.id, { billingType: 'Hourly' })"
                  class="billing-opt" 
                  [class.active]="activeTier.billingType === 'Hourly'"
                >Hourly</button>
                <button 
                  (click)="state.updateTier(activeTier.id, { billingType: 'Monthly Retainer' })"
                  class="billing-opt" 
                  [class.active]="activeTier.billingType === 'Monthly Retainer'"
                >Monthly Retainer</button>
              </div>
            </div>

            <!-- AI Tip for Project-based -->
            <div *ngIf="state.offering().type === 'Service' && activeTier.billingType === 'Per Project'" class="ai-tip-row">
              <div class="ai-badge-inline">
                <span class="material-icons" style="font-size: 14px;">auto_awesome</span>
                Unita AI
              </div>
              <span class="ai-tip-text">For Projects, Custom Quotes are usually recommended.</span>
            </div>

            <!-- AI Tip for Hourly -->
            <div *ngIf="state.offering().type === 'Service' && activeTier.billingType === 'Hourly'" class="ai-tip-row">
              <div class="ai-badge-inline">
                <span class="material-icons" style="font-size: 14px;">auto_awesome</span>
                Unita AI
              </div>
              <span class="ai-tip-text">For Hourly-based pricing, Price Ranges are usually recommended.</span>
            </div>

            <!-- Price Section -->
            <div class="input-block">
              <div class="label-with-toggle">
                <label>Price Range</label>
                <label *ngIf="state.offering().type === 'Service'" class="toggle-switch">
                  <input type="checkbox" [(ngModel)]="showPriceRange">
                  <span class="toggle-slider"></span>
                </label>
              </div>

              <!-- Monthly Retainer Layout (From/To with swap) -->
              <ng-container *ngIf="state.offering().type === 'Service' && activeTier.billingType === 'Monthly Retainer' && showPriceRange()">
                <div class="retainer-price-section">
                  <div class="price-row">
                    <span class="price-label">From</span>
                    <div class="price-input-group">
                      <div class="price-input-box">
                        <span class="currency-label">NZD</span>
                        <input 
                          type="number" 
                          [(ngModel)]="activeTier.price"
                          (ngModelChange)="state.updateTier(activeTier.id, { price: $event })"
                          placeholder="1600.00"
                        >
                      </div>
                      <div class="period-select-wrapper">
                        <select 
                          [(ngModel)]="activeTier.pricePeriod"
                          (ngModelChange)="state.updateTier(activeTier.id, { pricePeriod: $event })"
                        >
                          <option value="Month">Month</option>
                          <option value="Year">Year</option>
                        </select>
                        <span class="material-icons select-arrow" style="font-size: 14px;">arrow_drop_down</span>
                      </div>
                    </div>
                  </div>
                  <div class="swap-icon">
                    <span class="material-icons" style="font-size: 16px; color: #9ca3af;">swap_horiz</span>
                  </div>
                  <div class="price-row">
                    <span class="price-label">To</span>
                    <div class="price-input-group">
                      <div class="price-input-box">
                        <span class="currency-label">NZD</span>
                        <input 
                          type="number" 
                          [(ngModel)]="activeTier.priceMax"
                          (ngModelChange)="state.updateTier(activeTier.id, { priceMax: $event })"
                          placeholder="2400.00"
                        >
                      </div>
                      <div class="period-select-wrapper">
                        <select 
                          [(ngModel)]="activeTier.pricePeriod"
                          (ngModelChange)="state.updateTier(activeTier.id, { pricePeriod: $event })"
                        >
                          <option value="Month">Month</option>
                          <option value="Year">Year</option>
                        </select>
                        <span class="material-icons select-arrow" style="font-size: 14px;">arrow_drop_down</span>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>

              <!-- Hourly / Per Project with Range -->
              <ng-container *ngIf="state.offering().type === 'Service' && activeTier.billingType !== 'Monthly Retainer'">
                <div class="price-range-row">
                  <div class="price-input-box">
                    <span class="currency-label">NZD</span>
                    <input 
                      type="number" 
                      [(ngModel)]="activeTier.price"
                      (ngModelChange)="state.updateTier(activeTier.id, { price: $event })"
                      [placeholder]="activeTier.billingType === 'Hourly' ? '25 / hr' : '550.00'"
                    >
                    <span *ngIf="activeTier.billingType === 'Hourly' && activeTier.billingType" class="unit-suffix">/ hr</span>
                  </div>
                  <ng-container *ngIf="showPriceRange()">
                    <span class="range-separator">â€”</span>
                    <div class="price-input-box">
                      <span class="currency-label">NZD</span>
                      <input 
                        type="number" 
                        [(ngModel)]="activeTier.priceMax"
                        (ngModelChange)="state.updateTier(activeTier.id, { priceMax: $event })"
                        [placeholder]="activeTier.billingType === 'Hourly' ? '55 / hr' : '880.00'"
                      >
                      <span *ngIf="activeTier.billingType === 'Hourly' && activeTier.billingType" class="unit-suffix">/ hr</span>
                    </div>
                  </ng-container>
                </div>
              </ng-container>

              <!-- Product Offering: Single Price -->
              <ng-container *ngIf="state.offering().type === 'Product'">
                <div class="price-range-row">
                  <div class="price-input-box single">
                    <span class="currency-label">NZD</span>
                    <input 
                      type="number" 
                      [(ngModel)]="activeTier.price"
                      (ngModelChange)="state.updateTier(activeTier.id, { price: $event })"
                      placeholder="550.00"
                    >
                  </div>
                </div>
              </ng-container>

              <!-- Subscription Offering: Price with /month -->
              <ng-container *ngIf="state.offering().type === 'Subscription'">
                <div class="price-range-row">
                  <div class="price-input-box with-period">
                    <span class="currency-label">NZD</span>
                    <input 
                      type="number" 
                      [(ngModel)]="activeTier.price"
                      (ngModelChange)="state.updateTier(activeTier.id, { price: $event })"
                      placeholder="129.99"
                    >
                    <span class="period-suffix">/ month</span>
                  </div>
                </div>
              </ng-container>
            </div>

            <!-- Yearly Discount Section (For Subscriptions) -->
            <div *ngIf="state.offering().type === 'Subscription'" class="input-block">
              <div class="label-with-toggle">
                <label>Enable Yearly Discount</label>
                <label class="toggle-switch">
                  <input 
                    type="checkbox" 
                    [checked]="activeTier.hasYearlyDiscount"
                    (change)="onDiscountToggle($event)"
                  >
                  <span class="toggle-slider"></span>
                </label>
              </div>

              <div *ngIf="activeTier.hasYearlyDiscount" class="yearly-discount-box">
                <div class="discount-col">
                  <span class="discount-label">Discount</span>
                  <div class="discount-select-wrapper">
                    <select 
                      [(ngModel)]="activeTier.yearlyDiscountPercentage"
                      (ngModelChange)="state.updateTier(activeTier.id, { yearlyDiscountPercentage: $event })"
                    >
                      <option [value]="5">5%</option>
                      <option [value]="10">10%</option>
                      <option [value]="15">15%</option>
                      <option [value]="20">20%</option>
                    </select>
                    <span class="material-icons select-arrow" style="font-size: 14px;">arrow_drop_down</span>
                  </div>
                </div>
                <div class="user-pays-col">
                  <span class="discount-label">User Pays</span>
                  <div class="yearly-price">
                    <span class="original-price">{{ yearlyOriginalPrice | number:'1.2-2' }}</span>
                    <span class="discounted-price">{{ yearlyDiscountedPrice | number:'1.2-2' }}</span>
                    <span class="per-year">per Year</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Request Quote Only -->
            <div class="input-block quote-section">
              <div class="label-with-toggle">
                <label>Request Quote Only</label>
                <label class="toggle-switch">
                  <input 
                    type="checkbox" 
                    [(ngModel)]="activeTier.isQuoteOnly"
                    (ngModelChange)="state.updateTier(activeTier.id, { isQuoteOnly: $event })"
                  >
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <p class="help-text">Hide price, show "Request Quote only"</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Editor Footer -->
      <div class="editor-footer">
        <div class="popular-toggle">
          <span class="material-icons" style="font-size: 16px; color: #9ca3af;">star</span>
          <span>Mark as Popular Choice</span>
          <label class="toggle-switch">
            <input 
              type="checkbox" 
              [(ngModel)]="activeTier.isPopular"
              (ngModelChange)="state.updateTier(activeTier.id, { isPopular: $event })"
            >
            <span class="toggle-slider"></span>
          </label>
        </div>
        <button (click)="deleteActiveTier()" class="delete-tier-btn">
          <span class="material-icons" style="font-size: 16px;">delete</span>
          Delete Tier
        </button>
      </div>
    </div>
  </ng-template>
</div>