<div class="builder-layout">
  <main class="builder-content">
    <!-- Single light-gray panel: stepper, content, footer aligned inside one elevated box -->
    <div class="main-panel">
      <!-- Stepper -->
      <div class="stepper-row">
        <div class="stepper-row-inner">
          <div class="stepper-container">
            <div class="stepper-line"></div>
            <div class="steps">
              <div *ngFor="let label of stepLabels; let i = index" class="step-item"
                [class.active]="currentStep() === (i + 1)" 
                [class.completed]="currentStep() > (i + 1) || (i === 0 && step1Complete())">
                <div class="step-circle">
                  <ng-container *ngIf="currentStep() > (i + 1) || (i === 0 && step1Complete()); else stepNum">
                    <svg class="step-check-icon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M5 12l5 5 9-9"/>
                    </svg>
                  </ng-container>
                  <ng-template #stepNum>{{ i + 1 }}</ng-template>
                </div>
                <span class="step-label">{{ label }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Scrollable Content Area -->
      <div class="scroll-area">
        <div class="content-width" [class.content-width--wide]="currentStep() === 4">
          <div class="step-wrapper">
            <ng-container [ngSwitch]="currentStep()">
              <app-step-selection *ngSwitchCase="1" (next)="nextStep()" (openPreview)="togglePreviewDialog()"></app-step-selection>
              <app-step-details *ngSwitchCase="2" (next)="nextStep()" (back)="prevStep()" (openPreview)="togglePreviewDialog()"></app-step-details>
              <app-step-pricing *ngSwitchCase="3" (next)="nextStep()" (back)="prevStep()" (openPreview)="togglePreviewDialog()"></app-step-pricing>
              <app-step-media *ngSwitchCase="4" (finish)="finish()" (back)="prevStep()"></app-step-media>
            </ng-container>
          </div>
        </div>
      </div>

      <!-- Navigation Footer: aligned with panel edges -->
      <footer class="builder-footer">
        <div class="footer-inner" [class.footer-inner--wide]="currentStep() === 4">
          <div class="footer-left">
            <button (click)="finish()" class="footer-btn btn-secondary">Cancel</button>
          </div>
          <div class="footer-center">
            <button *ngIf="currentStep() > 1" (click)="prevStep()" class="footer-btn btn-outline">
              <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none">
                <path d="M19 12H5M12 19l-7-7 7-7"></path>
              </svg>
              Previous
            </button>
          </div>
          <div class="footer-right">
            <button (click)="nextStep()" [disabled]="currentStep() === 1 && !step1Complete()"
              class="footer-btn btn-primary">
              {{ currentStep() === 4 ? 'Finish' : (currentStep() === 1 ? 'Continue' : 'Next Step') }}
              <svg *ngIf="currentStep() < 4" viewBox="0 0 24 24" width="18" height="18" stroke="currentColor"
                stroke-width="2" fill="none">
                <path d="M5 12h14M12 5l7 7-7 7"></path>
              </svg>
            </button>
          </div>
        </div>
      </footer>
    </div>
  </main>

  <!-- Wide screen (2K 2560px+): side preview for steps 1â€“3 only; step 4 has its own -->
  <aside class="builder-preview" [class.builder-preview--step4]="currentStep() === 4">
    <app-preview-card></app-preview-card>
  </aside>

  <!-- Narrow screen: Card Preview dialog -->
  <div *ngIf="showPreviewDialog()" class="preview-dialog-backdrop" (click)="closePreviewDialog($event)" role="presentation">
    <div class="preview-dialog" role="dialog" aria-labelledby="preview-dialog-title" (click)="$event.stopPropagation()">
      <div class="preview-dialog-header">
        <h2 id="preview-dialog-title" class="preview-dialog-title">Card Preview</h2>
        <button type="button" class="preview-dialog-close" (click)="closePreviewDialog()" aria-label="Close">
          <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="preview-dialog-body">
        <app-preview-card></app-preview-card>
      </div>
    </div>
  </div>
</div>